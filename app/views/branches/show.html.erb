<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title></title>
  </head>
  <body>
    <%= @branch.title %>
    <%= @branch.instrument %>
    <%= @branch.description %>

    <% if @branch.user_id == current_user.id || @project.id == current_user.id %>
      <%= button_to 'Delete Branch', [@project, @branch], method: :delete, data: { confirm: 'Are you sure you want to delete this branch?'} %>
    <% end %><br><br>

    <% if current_user.id == @branch.user_id %>
      <%= simple_form_for ([@branch, @branch.tracks.build]) do |t| %>
        <%= t.hidden_field :user_id, :value => current_user.id %>
        <%= t.input :title, placeholder: 'Track Title' %>
        <%= t.input :text, placeholder: 'Track Description' %>
        <%= t.file_field :avatar %>
        <%= t.button :submit, button_html: { value: 'Upload Track' } %>
      <% end %>
    <% end %>

    <% if @branch.tracks.any? %>
      <% @branch.tracks.each do |track| %>
        <% if track.title != nil %>
          <audio src="<%=audio_path track.avatar%>" type="audio/mpeg" controls></audio>
        <% end %>
        <% if current_user.id == @branch.user_id || @project.id == current_user.id %>
          <a href="<%=track.avatar%>" download="Song">Download</a>
          <%= button_to 'Remove track', [@branch, track], method: :delete, data: {confirm: 'Are you sure you would like to delete this track?'} %>
        <% end %>
      <% end %>
    <% end %>

    <%= simple_form_for ([@branch, @branch.comments.build]) do |c| %>
      <%= c.hidden_field :user_id, :value => current_user.id %>
      <%= c.input :body, placeholder: 'Comment' %>
      <%= c.button :submit,'Save' %>
    <% end %>

    <%if @branch.comments.any? %>
      <% @branch.comments.each do |comment|%>
        <% if comment.user_id != nil %>
          <% user = User.find(comment.user_id) %>
          <%= user.email + " said:" %>
          <%= comment.body %>
        <% end %>
      <% end %>
    <% end %>

    <% if current_user.id == @branch.user_id %>
      <h2>Send a Mix request </h2>
      <%= simple_form_for ([@branch, @branch.requests.build]) do |r| %>
        <%= r.hidden_field :status, :value => "In progress" %>
        <%= r.hidden_field :receiver_id, :value => @branch.user_id %>
        <%= r.hidden_field :collab_id, :value => current_user.id %>
        <%= r.input :message, placeholder: 'Mix Request' %>
        <%= r.button :submit, 'Send Request' %>
      <% end %>

      <h2>Send a message to the project owner </h2>
      <% project = Project.find(@branch.project_id) %>
      <%= simple_form_for ([current_user, current_user.messages.build]) do |m| %>
        <%= m.hidden_field :recipient, :value => project.user_id %>
        <%= m.hidden_field :sender, :value => current_user.id %>
        <%= m.hidden_field :branch_id, :value => @branch.id %>
        <%= m.hidden_field :project_id, :value => @branch.project_id %>
        <%= m.input :body, placeholder: 'Message' %>
        <%= m.button :submit, button_html: { value: 'Save' } %>
      <% end %>
    <% end %>

  </body>
</html>
