
<!DOCTYPE html>
<html>
  <body>
    <script type="text/javascript">
    //establish all var that the js will use
    var audio, canvas, ctx, source, context, analyser, fbc_array, bars, bar_x, bar_width, bar_height;
    // initializa the MPÂ£ player after the oage is fully loaded
    window.addEventListener("load", initMp3Player, false);

    function initMp3Player(){
      audio = document.getElementById('audio_player');
      context = new AudioContext(); // AudioContext object instance
      analyser = context.createAnalyser(); // AnalyserNode method
      canvas = document.getElementById('analyser_render');
      ctx = canvas.getContext('2d');
      // Re-route audio playback into the processing graph of the AudioContext
      source = context.createMediaElementSource(audio);
      source.connect(analyser); //connects the the analyser var to the source media element
      analyser.connect(context.destination); //the destination of the context is the speakers
      frameLooper();
    }

    //frameLooper() animates any style of graphics you want to the audio frquency
    //looping at the defaut frame rate that the browser provides (approx. 60 FPS)

    function frameLooper(){
      window.requestAnimationFrame(frameLooper);
      fbc_array = new Uint8Array(analyser.frequencyBinCount);
      analyser.getByteFrequencyData(fbc_array);
      ctx.clearRect(0, 0, canvas.width, canvas.height); // Clear the canvas
      ctx.fillStyle = '#00CCFF'; // Color of the bars
      bars = 100;
      for (var i = 0; i < bars; i++) {
        bar_x = i * 3;
        bar_width = 2;
        bar_height = -(fbc_array[i] / 2);
        //  fillRect( x, y, width, height ) // Explanation of the parameters below
        ctx.fillRect(bar_x, canvas.height, bar_width, bar_height);
      }
    }
    </script>
    <%= @project.title %>
    <%= @project.genre %>
    <%= @project.description %>

    <% if @project.user_id == current_user.id %>
      <h2>Upload Your Master Track</h2>
      <%= simple_form_for ([@project, @project.tracks.build]) do |t| %>
        <%= t.input :title, placeholder: 'Track Title' %>
        <%= t.input :text, placeholder: 'Track Description' %>
        <%= t.file_field :avatar %>
        <%= t.button :submit, button_html: { value: 'Upload Track' } %>
      <% end %>
      <%= button_to 'Delete Project', project_path(@project), method: :delete, data: {confirm: 'Are you sure you want to delete this project?'} %>
    <% end %>

    <% if @project.tracks.count != 0%>

      <% @project.tracks.each do |track| %>
        <% if track.title != nil %>
          <div id="mp3_player">
            <div id="audio_box">
              <audio id="audio_player" src="<%=audio_path track.avatar%>" type="audio/mpeg" controls></audio>
            </div>
            <canvas id="analyser_render"></canvas>
          </div>
          <a href="<%=track.avatar%>" download="Song">Download</a>
          <%= button_to 'Remove track', project_track_path(@project, track), method: :delete, data: {confirm: 'Are you sure you would like to delete this track?'} %>
        <% end %>
      <% end %>
    <% end %>

    <%= simple_form_for ([@project, @project.comments.build]) do |c| %>
      <%= c.input :body, placeholder: 'Comment' %>
      <%= c.button :submit, button_html: { value: 'Save' } %>
    <% end %>

    <%if @project.comments.count != 0 %>
      <% @project.comments.each do |comment|%>
        <% if comment.user_id != nil %>
          <% user = User.find(comment.user_id) %>
          <%= user.email + " said:" %>
          <%= comment.body %>
        <% end %>
      <% end %>
    <% end %>

    <h2>Create a branch</h2>
    <%= simple_form_for ([@project, @project.branches.build]) do |b| %>
      <%= b.input :title, placeholder: 'Title' %>
      <%= b.input :instrument, placeholder: 'Instrument' %>
      <%= b.input :description, placeholder: 'Description' %>
      <%= b.button :submit, button_html: { value: 'Upload Track' } %>
    <% end %>


    <h2>Send a Collaboration request </h2>
    <%= simple_form_for ([@project, @project.requests.build]) do |r| %>
      <%= r.input :message, placeholder: 'Message' %>
      <%= r.button :submit, button_html: { value: 'Save' } %>
    <% end %>

    <h2> Mix requests <h2>
      <%if @project.branches.count != 0 %>
        <% @project.branches.each do |branch| %>
          <%if branch.requests.count != 0 %>
            <% branch.requests.each do |request| %>
              <% user = User.find(request.collab_id) %>
              <br><%= user.username %>
              <br>  <%= request.message %>
            <% end %>
          <% end %>
        <% end %>
      <% end %>

  </body>


</html>
